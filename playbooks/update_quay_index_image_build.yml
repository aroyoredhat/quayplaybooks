---
- name: Update QUAY_INDEX_IMAGE_BUILD tag in a YAML file
  hosts: all
  gather_facts: false
  vars:
    # Path to the YAML file to edit on this host
    target_file: ''

    # New numeric tag to set at the end of the image reference, e.g., 99716
    new_tag_number: ''

    # If true and the key is not found or file is missing, do not fail
    ignore_if_missing: false

  tasks:
    - name: Validate required variables are provided
      ansible.builtin.assert:
        that:
          - target_file | length > 0
          - new_tag_number | string | length > 0
          - new_tag_number | string is match('^\\d+$')
        fail_msg: "You must provide 'target_file' and a numeric 'new_tag_number' (e.g., 99716)"

    - name: Check file exists
      ansible.builtin.stat:
        path: "{{ target_file }}"
      register: target_stat

    - name: Fail when file is missing (unless ignore_if_missing)
      ansible.builtin.fail:
        msg: "Target file {{ target_file }} does not exist on host {{ inventory_hostname }}"
      when:
        - not target_stat.stat.exists
        - not ignore_if_missing

    - name: Update only the numeric tag part of QUAY_INDEX_IMAGE_BUILD (handles optional quotes)
      ansible.builtin.replace:
        path: "{{ target_file }}"
        # Matches: QUAY_INDEX_IMAGE_BUILD: [optional quote]<anything>:<digits>[optional same/any quote]
        regexp: "^(\\s*QUAY_INDEX_IMAGE_BUILD\\s*:\\s*[\"']?.*?:)(\\d+)([\"']?\\s*)$"
        replace: '\\1{{ new_tag_number | string }}\\3'
        backup: true
      register: replace_result
      when: target_stat.stat.exists

    - name: Optionally fail if key not found or pattern did not match
      ansible.builtin.fail:
        msg: |
          Could not find a line matching 'QUAY_INDEX_IMAGE_BUILD: <image>:<digits>' in {{ target_file }} on host {{ inventory_hostname }}; no changes made.
      when:
        - target_stat.stat.exists
        - (replace_result is not defined) or (not replace_result.changed)
        - not ignore_if_missing
